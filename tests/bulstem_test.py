# coding=utf-8

from __future__ import absolute_import, division, print_function, unicode_literals

import nltk
import unittest

from bulstem.stem import BulStemmer


def setUpModule():
    nltk.download('punkt')


class BulStemmerTest(unittest.TestCase):
    RULES_1_PATH = './rules/stem_rules_context_1_utf8.txt'
    RULES_2_PATH = './rules/stem_rules_context_2_utf8.txt'
    RULES_3_PATH = './rules/stem_rules_context_3_utf8.txt'

    def compare_texts(self, stemmer, stemmed_text, text):
        for (token, stem) in zip(nltk.casual_tokenize(text),
                                 nltk.casual_tokenize(stemmed_text)):
            self.assertEqual(stem, stemmer.stem(token))

    def test_full_stem_short(self):
        stemmer = BulStemmer.from_file(BulStemmerTest.RULES_2_PATH, min_freq=2, left_context=2)
        text = \
            '''
            Има първи вероятен случай на атипична пневмония в България, съобщи министърът на здравеопазването Божидар 
            Финков. Става дума за 33-годишен пациент, който на 16 април е пристигнал в България след продължителен 
            престой в Торонто, Канада, където вече са регистрирани 19 смъртни случая вследствие на тежкия остър 
            респираторен синдром (ТОРС). Точната диагнозата обаче не може да бъде установена в България и пробите ще 
            бъдат изпратени за изследване Световната здравна организация (СЗО).
            '''

        stemmed_text = \
            '''
            има първ вероят случа на атипич пневмони в българ, съобщ минист на здравеопазван божидар финков. 
            става дума за 33-годиш пациент, койт на 16 апр е пристигн в българ след продължител престо в торонт, канад, 
            къде вече са регистрира 19 смърт случа вследстви на тежк ост респиратор синдром (торс). 
            точн диагноз обач не може да бъде установ в българ и проби ще бъда изпрат за изследван светов здравн
            организаци (сзо).
            '''

        self.compare_texts(stemmer, stemmed_text, text)

    def test_full_stem_long(self):
        stemmer = BulStemmer.from_file(BulStemmerTest.RULES_2_PATH, min_freq=2, left_context=2)

        text = \
            '''
             През пролетта на 1186 г. най-старият брат [1] Теодор, който променил името си на Петър [2], бил провъзгласен за български цар. Но няма никакво съмнение, че и вторият брат Иван Асен също бил удостоен с тази титла. Липсва единомислие по въпроса кога е станало това. Сочат се годините 1188, 1190, 1191 [3], но те не намират подкрепа в изворите. Никита Хониат (а след него Теодор Скутариот и Ефрем) познава като цар само Петър: той единствен говори за коронацията на по-големия брат. Твърде често Иван Асен и Петър се споменават заедно, но в онези случаи, когато става дума за единия от двамата, почти винаги това е Иван Асен. Подобна е картината и у западните автори [4]. Българските извори са категорични. В „Синодика“ и поменниците Иван Асен е първият български цар след възстановяването на царството, който „освободил от гръцко робство българския народ“ [5]. Подобни са твърденията и на останалите български автори [6]. В същото време те или не познават Теодор-Петър или го поставят на второ място („Синодик“). Подобно е и писаното от Георги Акрополит, който не следва византийската традиция, също не „познава“ Петър и отбелязва, че Иван I Асен царувал девет години [7]. Очевидно след като отминал първоначалният ентусиазъм на българите и започнали да се изграждат основите на държавния апарат на възродената държава, за цар бил провъзгласен и Иван Асен — неговите качества са го наложили [8] — и по този начин била създадена своеобразна форма на държавно управление; двувластието, което съществувало през първите десет години от историята на Второто българско царство. Изворите са категорични: когато става дума за официален държавен акт, двамата братя стоят редом, но когато става дума за действия, Иван Асен е човекът, който държи държавното кормило. Петър постепенно се отдръпвал от реалната власт, запазвайки си само нейната външна изява и се оттеглил в отредения му апанаж, обхващащ Преславската област [9].
            Тържествените събития и чувствата постепенно отшумели и сторили място на действителността, която била сурова. Защото трябвало да се очаква отговорът на Византия. И той не закъснял. След като се разчуло, че българите овладели „градчетата и населените места оттатък Хемус“ (а и това, че Петър посегнал към короната и обул червените обувки) Исаак II Ангел повел лично войските си срещу българите [10]. Това станало в ранното лято на 1186 г. [11] Българите били заели старопланинските проходи, но ромеите успели да ги преодолеят и да достигнат до центъра на освободителното движение [12]. Иван Асен, въпреки че бил изправен пред по-многобройната и по-добре организираната византийска войска, не се поддал на паника. Неясните сведения показват, че след като не могъл да се справи със сила, той решил да излезе от тежкото положение чрез преговори. За крайния резултат от тези преговори можем само да се досещаме. Исаак II Ангел решил, че може да възложи управлението на земите между Дунав и Стара планина на двамата братя (или може би само на Петър?) [13]. След това той наредил да изгорят все още неприбраните от полето кръстци зърнени храни и без да възстанови византийските гарнизони се завърнал в Константинопол [14].
            Оттеглянето на ромеите било сигнал за българите да възобновят своите действия. Иван Асен или изпратени от него хора преминали в земите на север от Дунав (териториите на левия бряг на реката вероятно били приобщени към станалото в Търново) и скоро се завърнали с „многобройна съюзническа войска“ от кумани [15]. Този път намеренията на Иван Асен били изразени още по-категорично: българите нямало да се задоволят само с „управлението“ на Мизия (Северна България), но щели да пристъпят към изпълнението на вече обявената програма: обединението на всички български земи под скиптъра на българския цар. Последвалите събития — едва ли трябва да се очаква, че византийците гледали безучастно това, което ставало на север от Балкана — са познати само в основни линии. Никита Хониат, след като осъжда василевса, че не потеглил лично срещу българите, съобщава, че с ръководството на военните действия бил натоварен Йоан Дука Ангел [16], чичо на Исаак II Ангел. Той повел умело кампанията — така поне твърди Хониат, — но скоро бил отстранен, тъй като „гледал към царската власт“, т.е. бил обвинен в опит за узурпация [17]. Следващият стратег срещу българите бил кесарят Йоан Кантакузин [18]. Той подценил качествата на Иван Асен (най-често той ръководел действията на българите), а пък и бил лишен от зрение, и в едно нощно сражение бил напълно разбит. Никита Хониат с прискърбие и с възмущение отбелязва, че двамата братя, след като пленили обоза на ромеите, взели и облекли златотканите дрехи на кесаря и преминали тържествено пред победоносната си войска. Тази първа сериозна победа им позволила да пренесат военните действия в Тракия [19]. Така дошъл редът на победителя на норманите Алексий Врана [20], който трябвало да поеме командването на войските, определени да воюват срещу българите. Но той вместо да се отправи срещу България, проявил открито своя стремеж към императорската корона и насочил поверената му войска срещу византийската столица. Този метеж в Империята, завършил през пролетта или началото на лятото на 1187 г. с гибелта на претендента [21], позволил на Иван Асен и неговия брат да си отдъхнат, да наберат сили, да организират войската си и да започнат постоянни и все по-опасни действия из Тракия. Български отряди се появявали на различни места, избягвали основните византийски сили, нанасяли удари там, където не били очаквани. Хониат специално подчертава, че „това вършеше единият от братята — Асен“ [22]. В едно сражение край Лардея той едва не разгромил византийците, предвождани от василевса; след това постигнал успех край Берое, а сетне опустошил селищата край Филипопол (Пловдив) [23].
            Обезпокоен от засилващата се мощ на българите, объркван от тактиката на Иван I Асен, Исаак II Ангел решил да нанесе сериозен удар, като отново пренесе войната на север от Стара планина. През късната есен на 1187 г. той достигнал до Триадица (София), но започналата зима го принудила да се завърне в столицата и да отложи намеренията си за следващата година [24]. През пролетта на 1188 г. Исаак II Ангел предприел втория [25] си поход срещу възобновеното Българско царство. Никита Хониат, чиито описания в други случаи, много по-маловажни, са твърде разточителни, тук е съвсем лаконичен: „Заедно с настъпването на пролетта  [на 1188 г.] той  [Исаак II Ангел] отново потегли и отиде при Мизите. Впрочем той прекара при тях цели три месеца, положи много усилия да овладее крепостта, наричана Ловеч и като остави пак незавършено предприетото, потегли оттам и се завърна в царицата на градовете… Тогава василевсът плени жената на  [Иван] Асен и взе за заложник другия му брат Йоан  [Калоян]. Но и при това положение делата отиваха към по-лошо“ [26]. Обикновено се приема, че тази кампания, за която свидетелства Хониат, е завършила с т.нар. Ловешки мир. Но цитираният текст в никакъв случай не позволява подобно тълкуване (да не говорим за произволната идея, според която Калоян бил разменен с пленената (!) Елена, съпруга на Иван I Асен, и така третият брат попаднал в Константинопол като заложник) [27]. Той просто свидетелства за неуспеха на ромеите, поради което „делата отиваха към по-лошо“. Несполучливият поход на Исаак II Ангел през пролетта-лятото на 1188 г., освен моралното си въздействие (разбира се, различно за двете страни) отбелязал и края на един период в освободителните борби на българите, довел до възобновяването на българската държава, до обявяването на държавния суверенитет чрез провъзгласяването на цар и освобождаването на част от българските земи или както пишат някои западни автори „част от България около Дунава и части от Тракия“ [28].
            Краят на кампанията от лятото на 1188 г. означавал само временен отдих за българите. Осъществили добре първоначалния си замисъл, двамата братя изчаквали удобния момент, за да пристъпят към изпълнението на първата част от своята програма: освобождаването и обединението под едно управление на основните български земи — Мизия (Северна България), Тракия и Македония. Подходящият момент за първото действие настъпил твърде скоро. В началото на следната 1189 г. до българските предели достигнала войската на Фридрих I Барбароса — една от основните сили в Третия кръстоносен поход [29]. Иван I Асен и Петър не пропуснали да се възползват от тази възможност. Първото пратеничество, проводено от двамата братя пристигнало при германския император, когато той се намирал в Ниш. Западните автори — основните извори за тези събития — представят с различни думи един и същи епизод: българите предложили помощ на кръстоносците във възможния им сблъсък с Византия и изразили готовност да се подчинят на Римската империя; в замяна те искали Ниш и околностите, както и „всички други свои земи“ (местоимението „свои“ остава твърде неопределено); кръстоносците подчинили част от България  и след това сключили съюз с „Калопетър“ против константинополския император [30]. Как биха могли да бъдат обяснени тези действия на Асеневци? Най-кратко: заедно с кръстоносците срещу Константинопол. Няма съмнение, че Иван I Асен и Петър са се стремели да отстранят Империята от пътя си, да я изместят. Но дали искали само „всички други свои земи“? Или нещо повече? Твърдението, че двамата братя проявили желание да се подчинят на „Римската империя“(Фридрих I Барбароса) чрез клетва, едва ли трябва да се схваща буквално. По-точен е Ансберт, който говори за съюз между двете страни, вероятно потвърден с клетва и от едните, и другите.
            Втората среща между българите и Фридрих I станала в Адрианопол. Там „Калопетър, господарят на власите и на голяма част от българите, който се наричаше император и изискваше от римския император да му възложи императорската корона на гръцкото кралство  срещу помощ от 40 000-на войска във войната срещу ромеите [31]. Еволюцията в българските искания е очевидна. Този път сделката е конкретна: Иван I Асен и Петър ще помогнат на кръстоносците да се справят с Византия; в замяна на това Фридрих I Барбароса след бъдещата победа и разгром на ромеите ще отстъпи короната на византийските василевси на по-стария от братята. Така императорът на Свещената римска империя на германците — един от двамата владетели, поели политическото и идеологическото наследие на някогашната Римска империя — ще утвърди отново традиционния модел (двама императори), но ще санкционира една малка промяна в него: короната на константинополските василевси ще премине във владение на българите. По този начин голямата идея на цар Симеон ще бъде осъществена! [32]. Краят на преговорите с Фридрих I Барбароса е известен. Германският император, въпреки че дал благосклонен отговор на българското пратеничество, впоследствие предпочел да се споразумее с Византия и да продължи пътя си към Светите места, вместо да се вплете в една война на Балканите. Заминаването на кръстоносците не само лишило Иван I Асен и Петър от възможен съюзник срещу Империята, но и отново изправило лице в лице България и Византия. И сблъсъкът не закъснял.
            През 1190 г. Исаак II Ангел решил да потегли отново на поход срещу България, тъй като българите и куманите „постоянно нападали подвластните на ромеите земи“. Едва ли трябва да има съмнения в твърдението на Хониат, че българите постоянно безпокоили ромейските предели (познатата тактика на Иван Асен) — вероятно български и кумански отряди непрекъснато кръстосвали Тракия, особено след изтеглянето на войската на Фридрих I Барбароса. Но намеренията на Исаак II Ангел едва ли са се ограничавали с възпирането на тези набези. Неговите действия показват, че той решил да стори нов, може би последен, опит да унищожи възобновеното Българско царство. Византийският император отново проникнал в земите отвъд Хемус, този път по Черноморското крайбрежие [33]. Добре екипираната войска, подпомогната от флот, който трябвало да съдейства на основните сили, като попречи на куманите да преминат Дунава [34], била сериозна заплаха и Иван Асен решил да се затвори в Търново [35]. Неговият план и този път сполучил. Исаак II Ангел, уплашен от възможно нападение в гръб, вдигнал обсадата на българската столица и се отправил на юг. Но в един от старопланинските проходи (вероятно Тревненския) българските войски нанесли голямо поражение на византийците. Самият император едва се спасил с бягство, като се почувствал в сигурност едва след като пристигнал в Берое [36].
            Победата в кампанията през 1190 г. показала още веднъж воинските качества и добродетели на Иван Асен, неговото тактическо умение и стратегическо мислене. За разлика от първите два похода на север от Стара планина, този път Исаак II Ангел бил принуден не само да се оттегли, но и по време на това отстъпление понесъл големи загуби в човешки сили. Но по-голямото значение на победата в Тревненския проход се криело в нейния морален отзвук. Още веднъж, и този път окончателно, тя показала по убедителен начин, че България съществува, че не може да бъде унищожена, че нейните съдбини се ръководят от човек, достоен да изпълни тежките повели на времето. Победата през 1190 г. била сигнал за всеобщо настъпление на българите в Тракия и Македония.
            Действията на Иван I Асен през следващите пет години могат да бъдат характеризирани само с едно изречение — усилия за постигане на целта поставена в 1186 г. — освобождаване и политическо обединение на всички български земи. Тези усилия били осъществявани с помощта на умела и гъвкава тактика. Българският цар разчитал на краткотрайни кампании, на бързи операции, на светкавични походи, които не винаги носели териториални придобивки, но непрекъснато тревожели Империята. Друга отличителна черта на военните планове на Иван Асен била постоянната, и то твърде бърза, всеки път неочаквана смяна на посоката на нанасяния удар. Така през 1191 г. (или 1192 г.) българите се появили по Черноморското крайбрежие и превзели Варна и сетне Анхиало. И докато Исак II Ангел възстановявал своето господство над опустошената област, Иван Асен се прехвърлил в западните части на полуострова и овладява Средец, Ниш и Стоб [37]. А наскоро след това български отряди се появили в околностите на Пловдив [38]. Исаак II се опитал да противодейства с различни средства. Така например той възложил надеждите си на своя братовчед Константин Ангел, дук на флота, когото назначил за стратег и изпратил в Пловдив [39]. Но твърде скоро, без да постигне нещо съществено, младият и енергичен военачалник започнал метеж срещу василевса, сетне бил заловен и ослепен [40]. Веднага след това Иван Асен повел войските си на поход и през Средец, Пловдив, достигнал до Адрианопол [41], а край Аркадиопол нанесъл поражение на ромеите, предвождани от Алексий Гид и Василий Ватаци [42], показвайки очертаващото се превъзходство на българската държава.
            При това положение на Исаак II Ангел не оставало нищо друго, освен да интернационализира конфликта (за пръв път от 1186 г.!) и да се опита да се справи с България, използвайки външна помощ. За да подготви полето за подобна акция, византийският василевс потеглил на поход срещу сърбите [43], които били в съюз с България от времето на Третия кръстоносен поход. След известна сполука той пристъпил към изпълнението на втората част от плана си: потърсил сътрудничеството на тъста си унгарския крал Бела III и се уговорил с него за съвместни военни действия срещу България през пролетта на 1195 г. [44] Планът на Исаак II Ангел бил добре замислен, но останал само план. Когато василевсът се подготвял за самата кампания, заговорът организиран от брат му Алексий сполучил и той бил свален от власт, лишен от зрение и хвърлен в затвор [45]. Новият император имал достатъчно грижи около утвърждаването си на престола и не само се отказал от замислената военна кампания срещу България, но и се опитал да сключи мир с Иван Асен. Никита Хониат специално подчертава неговите усилия, пишейки недвусмислено, че Алексий III Ангел първи сторил крачка към мира, който не бил постигнат, тъй като условията на Иван I Асен били „безчестни за ромеите“ [46]. Византийският историк премълчава какви са били исканията на българите и това мълчание дава възможност за различни тълкувания [47]. Няма съмнение, че тъкмо по това време българският цар не е имал сериозни намерения да сключва мир с Византия. На България в 1195 г. не бил нужен сигурен и продължителен мир, който би й затворил пътя към постигането на основната цел — освобождението и обединението на всички български земи. Иван Асен не само че не желаел да се откаже от плановете си или поне да ги отсрочи, но съзирал, че моментът е твърде удобен за тяхното осъществяване: новият василевс трябвало да се погрижи за собственото си положение. Но по-важно било друго — за първи път от началото на освободителната война Империята проявила слабост и потърсила мира с България. При това положение Иван Асен решил, че трябва да постави такива условия, които биха принудили византийците сами да се откажат от желания от тях мир. Това неприемливо „безчестно“ искане, което възмутило Никита Хониат (а и василевса, разбира се!), би могло да бъде само едно: искането отправено към Фридрих I Барбароса българският владетел да получи короната на византийските василевси. Но този път това искане било отправено не към чужденец, а към самия Константинопол и Иван Асен не останал изненадан от отговора, защото го очаквал. Нещо повече, отрицателният отговор му бил необходим (заедно с мотивацията, че Алексий III Ангел е незаконен василевс, тиран), за да оправдае, ако станело нужда, по-нататъшните си военни действия срещу Византия [48].
            Едва византийските пратеници били напуснали Търново и Иван Асен, без да губи време, пристъпил към изпълнение на намеренията си. Този път той оставил Тракия на спокойствие и насочил своя поглед към северозападните части на полуострова и Македония. Категорични сведения в изворите липсват, но анализът на по-късните известия показва, че към това време били освободени и присъединени към българската държава областта около Браничево и Белград [49]. Оттам Иван Асен се спуснал на юг и наложил трайно своята власт над Средец (София). Тъкмо тогава той наредил да пренесат в Търново мощите на св. Иван Рилски (маджарите наскоро ги били върнали след краткотрайно пребиваване в Естергом) [50]. След това, придвижвайки се по долината на Струма, той достигнал до Източна Македония, където в едно сражение край Сяр разбил изпратената насреща му византийска войска и пленил нейния стратег Алексий Аспиет [51]. През следващата 1196 г. Иван Асен продължил настъплението си в същата посока. Хониат съобщава, че с „още по-голяма самоувереност той нападнал областите около Стримон и Амфипол“. И пак край Сяр се срещнал с нова византийска войска, този път командвана от императорския зет севастократор Исаак. Сражението завършило с пълна победа на българите, а самият Исаак, който не разбрал „военната хитрост и измама“ на Иван Асен, „бил пленен“ [52].
            Победоносните действия на Иван Асен, за когото нямало препятствия на бойното поле, били спрени изненадващо, и то по друг начин: българският цар бил убит от Иванко [53]. Убийството на българския цар е било обект на много и различни обяснения [54]. Но анализът на изворите — както на провиденциалистките елементи в разказа (предсказанието на византийския свещеник за очакваната насилствена смърт на българския цар), така и на прикритата чрез тях реалност — показва без колебание, че Иван Асен ставал все по-силен и по-страшен враг за Византия. Тъй като той не можел да бъде спрян на бойното поле, трябвало да бъде спрян с други средства. Едва ли има съмнение, че ромеите чрез севастократор Исаак сполучили да намерят подходящия човек в лицето на Иванко, да го убедят, че е достоен да поеме царската корона и да го уверят в пълното съдействие на Византия. Останалото било лесно [55].
            В края на първото си десетилетие възродена България вече била укрепнала и повече не била застрашена от срив. Ако в началото (1186 г.) Иван I Асен и Петър били отцепници, узрпатори, а в 1189 г. според хронистите на Третия кръстоносен поход те владеели „по-голямата част от България и откъм Дунава, чак дотам, където той се влива в морето“ и претендирали за „императорската корона на гръцкото кралство“, то към 1192–1193 г. тя вече била царство (Никита Хониат), което обхващало и части от Тракия и Македония, както и големи области на север от Дунав. България си имала цар и архиепископ, без необходимост от външно „признание“ (Византия се противопоставяла на България като държава, а не на титлата на нейния владетел или на сана на нейния църковен глава, тъй като според политическата теория това било вътрешен проблем на Империята), резултат от спонтанно движение на българите, което се основавало на историческата традиция и приемствеността с Първото българско царство.
            Опитът на Иванко да узурпира престола, очевидно подкрепян от Византия, поставил съдбата на наскоро възстановеното Българско царство на сериозно изпитание. Заговорниците овладели Търново и очаквали помощ от Алексий III Ангел, за да покорят цяла Мизия [56]. Сега всичко било в ръцете на Петър, който от известно време се бил откъснал от ръководството на държавните дела и се установил в апанажа си с център някогашната българска столица Велики Преслав, запазвайки външните белези на царската власт [57]. От оскъдните свидетелства на Никита Хониат може да се допусне, че Петър реагирал бързо, обсадил престолния град, където се бил укрепил Иванко [58], но не се осмелил да го атакува. Трудно е да се отсъди кое от двете решения било най-правилното, но действията на Петър дали резултат. Не бива да се забравя, разбира се, че успехът на Петър се дължал и на византийското нежелание или неумението на Империята да се намеси по-активно и по-сполучливо в българските дела [59]. Факт е обаче, че Иванко и най-близките му сподвижници намерили убежище в Константинопол [60]. По този начин „властта над мизите отново минала изцяло в ръцете на Петър“ [61].
            Самостоятелното царуване на Петър било твърде кратко и за него се знае съвсем малко. Отново виждаме в действие двувластието. Не би могло да се каже със сигурност дали Петър се е страхувал, че няма да се справи сам или се е опрял на съществуващата вече традиция, но Хониат пише недвусмислено: той взел за „помощник в  [държавните] дела и участник в управлението Калоян“ [62]. Единствено Скутариот твърди, че Петър, след като взел за свой помощник по-малкия си брат, с всички сили „опустошавал ромейските земи“ [63]. А Хониат добавя, че „никой от нас не се противопостави на Петър“ [64]. Но новият български цар нямал време да покаже държавническите си способности; „малко по-късно“ и той завършил живота си като Иван Асен — бил пронизан от меча на свой сънародник [65]. 
            '''

        # The text is stemmed by the Perl version and transformed to lower-case.
        stemmed_text = \
            '''
            през пролет на 1186 г. най-стар брат [1] теодор, койт промен име си на петър [2], бил провъзглас за българск цар. но няма никак съмнени, че и втори брат ива асен също бил удосто с тази титл. липсв единомисли по въпрос кога е стана това. соча се годин 1188, 1190, 1191 [3], но те не намира подкреп в извор. ники хониат (а след него теодор скутариот и ефрем) познав като цар само петър: той единств говор за коронаци на по-гол брат. твърд чест ива асен и петър се споменава заед, но в онез случа, когат става дума за един от двамат, почт винаг това е ива асен. подоб е картин и у запад автор [4]. българск извор са категорич. в „синоди“ и поменни ива асен е първи българск цар след възстановяван на царств, койт „освобод от гръцк робств българск народ“ [5]. подоб са твърден и на остан българск автор [6]. в същот време те или не познава теодор-пет или го постав на второ мяст („синоди“). подоб е и писа от георг акрополит, койт не следв византийск традици, също не „познав“ петър и отбелязв, че ива i асен царува девет годин [7]. очевид след като отмин първоначал ентусиаз на българ и започн да се изгражда основ на държав апара на възрод държав, за цар бил провъзглас и ива асен — негов качеств са го налож [8] — и по този начин била създа своеобраз форм на държав управлени; двувласти, коет съществува през първ десет годин от истори на второт българск царств. извор са категорич: когат става дума за официал държав акт, двамат братя стоят редом, но когат става дума за действи, ива асен е чове, койт държ държав корм. петър постепен се отдръпва от реал власт, запазва си само нейн външ изяв и се оттегл в отре му апанаж, обхваща преславск област [9].
            тържеств съби и чувств постепен отшум и стори мяст на действителност, коят била суров. защот трябва да се очак отговор на византи. и той не закъсн. след като се разчу, че българ овла „градче и насел мест оттатъ хемус“ (а и това, че петър посегн към корон и обу черв обувк) исаак ii ангел пове лично войск си срещу българ [10]. това стана в ранно лято на 1186 г. [11] българ били заел старопланинск проход, но роме усп да ги преодол и да достигн до цент на освободител движени [12]. ива асен, въпрек че бил изправ пред по-многобро и по-добре организира византийск войск, не се подда на пани. неяс сведен показва, че след като не могъл да се справи със сила, той реши да изл от тежк положени чрез преговор. за крайни резулта от тези преговор можем само да се досеща. исаак ii ангел реши, че може да възлож управлени на земи между дунав и стара плани на двамат братя (или може би само на петър?) [13]. след това той наред да изгор все още неприбра от поле кръст зърн храни и без да възстанов византийск гарнизон се завърн в константинопол [14].
            оттеглян на роме било сигн за българ да възобнов своит действи. ива асен или изпрат от него хора премин в земи на север от дунав (територи на леви бряг на рекат вероят били приобщ към стана в търнов) и скоро се завърн с „многобро съюзническ войск“ от кума [15]. този път намерен на ива асен били израз още по-категорич: българ няма да се задовол само с „управлени“ на мизи (север българ), но щели да пристъп към изпълнени на вече обяв програм: обединени на всичк българск земи под скипт на българск цар. последва съби — едв ли трябва да се очак, че византи гледа безучаст това, коет става на север от балка — са позн само в основ лини. ники хониат, след като осъжд василевса, че не потегл лично срещу българ, съобщав, че с ръководств на воен действи бил натовар йоан дука ангел [16], чичо на исаак ii ангел. той пове уме кампан — така поне твърд хониат, — но скоро бил отстран, тъй като „гледа към царск власт“, т.е. бил обвин в опи за узурпаци [17]. следва стратег срещу българ бил кесар йоан кантакузи [18]. той подцен качеств на ива асен (най-чест той ръковод действи на българ), а пък и бил лишен от зрени, и в едн нощно сражени бил напъл разби. ники хониат с прискърби и с възмущени отбелязв, че двамат братя, след като плени обоз на роме, взели и обл златотка дрехи на кесар и премин тържеств пред победонос си войск. тази първ сериоз побед им позвол да пренес воен действи в траки [19]. така дошъл редът на победител на норма алексий врана [20], койт трябва да поем командван на войск, определ да воюва срещу българ. но той вмест да се отправ срещу българ, прояв откри своя стремеж към императорск корон и насоч повер му войск срещу византийск столиц. този метеж в импери, завърш през пролет или нача на лятот на 1187 г. с гибел на претенден [21], позвол на ива асен и негов брат да си отдъхн, да набера сили, да организира войск си и да започн постоян и все по-опас действи из траки. българск отряд се появява на различ мест, избягва основ византийск сили, нанася удар там, къде не били очаква. хониат специал подчертав, че „това върш един от братят — асен“ [22]. в едн сражени край лард той едв не разгром византи, предвожда от василевса; след това постигн успех край берое, а сетн опустош селищ край филипопол (пловдив) [23].
            обезпоко от засилва се мощ на българ, обърква от тактик на ива i асен, исаак ii ангел реши да нанес сериоз удар, като отнов пренес войн на север от стара плани. през късн есен на 1187 г. той достигн до триадиц (софи), но започн зима го принуд да се завърн в столиц и да отлож намерен си за следва годин [24]. през пролет на 1188 г. исаак ii ангел предпри втори [25] си поход срещу възобнов българск царств. ники хониат, чиит опи в други случа, много по-маловаж, са твърд разточител, тук е съвсем лаконич: „заед с настъпван на пролет  [на 1188 г.] той  [исаак ii ангел] отнов потег и отид при мизи. впрочем той прекар при тях цели три месец, полож много усил да овлад крепост, нарича ловеч и като остав пак незавърш предприе, потег отта и се завър в цариц на градов… тогав василевсът плени жена на  [ива] асен и взе за заложни други му брат йоан  [калоян]. но и при това положени дела отива към по-лош“ [26]. обикнов се прием, че тази кампа, за коят свидетелств хониат, е завърш с т.нар. ловешк мир. но цитира текст в никак случа не позволяв подоб тълкуван (да не говор за произвол иде, според коят калоян бил размен с пленен (!) елен, съпруг на ива i асен, и така третият брат попадн в константинопол като заложни) [27]. той прост свидетелств за неуспех на роме, пора коет „дела отива към по-лош“. несполучлив поход на исаак ii ангел през пролетта-лятот на 1188 г., освен морал си въздействи (разбир се, различ за двете страни) отбел и края на един период в освободител борб на българ, дове до възобновяван на българск държав, до обявяван на държав суверенитет чрез провъзгласяван на цар и освобождаван на част от българск земи или както пиша няко запад автор „част от българ окол дунав и част от траки“ [28].
            краят на кампан от лятот на 1188 г. означава само времен отдих за българ. осъществ добре първоначал си замис, двамат братя изчаква удоб момент, за да пристъп към изпълнени на първ част от своят програм: освобождаван и обединени под едн управлени на основ българск земи — мизи (север българ), траки и македони. подходя момент за първ действи настъп твърд скоро. в нача на следн 1189 г. до българск предел достигн войск на фридр i барбарос — едн от основ сили в трети кръстонос поход [29]. ива i асен и петър не пропусн да се възползва от тази възможност. първ пратеничеств, провод от двамат братя пристигн при германск император, когат той се намира в ниш. запад автор — основ извор за тези съби — представ с различ думи един и същи епизод: българ предлож помощ на кръстонос във възмож им сблъсъ с византи и израз готовност да се подчин на римск импери; в замя те иска ниш и околност, както и „всичк други свои земи“ (местоимени „свои“ остав твърд неопредел); кръстонос подчин част от българ  и след това сключил съюз с „калопет“ против константинополск император [30]. как биха могл да бъда обясн тези действи на асенев? най-кратк: заед с кръстонос срещу константинопол. няма съмнени, че ива i асен и петър са се стреме да отстран импери от пътя си, да я измест. но дали иска само „всичк други свои земи“? или нещо повеч? твърдени, че двамат братя прояв желани да се подчин на „римск импери“(фридр i барбарос) чрез клетв, едв ли трябва да се схваща буквал. по-точ е ансберт, койт говор за съюз между двете страни, вероят потвърд с клетв и от едн, и други.
            втора среща между българ и фридр i стана в адрианопол. там „калопет, господар на власи и на голям част от българ, койт се нарича император и изисква от римск император да му възлож императорск корон на гръцк кралств  срещу помощ от 40 000-на войск във войн срещу роме [31]. еволюци в българск иска е очевид. този път сделк е конкрет: ива i асен и петър ще помогн на кръстонос да се справя с византи; в замя на това фридр i барбарос след бъдещ побед и разгром на роме ще отстъп корон на византийск василевси на по-стар от братят. така император на свещен римск импери на герман — един от двамат владет, поел политическ и идеологическ наследи на някогаш римск импери — ще утвърд отнов традицион модел (двама император), но ще санкционир едн малк промя в него: корон на константинополск василевси ще премин във владени на българ. по този начин голям иде на цар симеон ще бъде осъществ! [32]. краят на преговор с фридр i барбарос е извест. германск император, въпрек че дал благосклон отговор на българск пратеничеств, впоследстви предпоч да се споразум с византи и да продълж пътя си към свети мест, вмест да се вплете в едн войн на балка. заминаван на кръстонос не само лиши ива i асен и петър от възмож съюзни срещу импери, но и отнов изправ лице в лице българ и византи. и сблъсъ не закъсн.
            през 1190 г. исаак ii ангел реши да потег отнов на поход срещу българ, тъй като българ и кума „постоян напада подвласт на роме земи“. едв ли трябва да има съмн в твърдени на хониат, че българ постоян безпоко ромейск предел (позн такти на ива асен) — вероят българск и куманск отряд непрекъсн кръстосва траки, особ след изтеглян на войск на фридр i барбарос. но намерен на исаак ii ангел едв ли са се ограничава с възпиран на тези набе. негов действи показва, че той реши да стори нов, може би послед, опи да унищож възобнов българск царств. византийск император отнов проникн в земи отвъд хемус, този път по черноморск крайбрежи [33]. добре екипира войск, подпомогн от флот, койт трябва да съдейств на основ сили, като попре на кума да премин дунав [34], била сериоз запл и ива асен реши да се затвор в търнов [35]. негов план и този път сполуч. исаак ii ангел, уплаш от възмож нападени в гръб, вдигн обсад на българск столиц и се отправ на юг. но в един от старопланинск проход (вероят тревненск) българск войск нанес голям поражени на византи. сами император едв се спасил с бягств, като се почувства в сигурност едв след като пристигн в берое [36].
            побед в кампан през 1190 г. пока още веднъж воинск качеств и добродет на ива асен, негов тактическ умени и стратегическ мислен. за разли от първ два поход на север от стара плани, този път исаак ii ангел бил принуд не само да се оттег, но и по време на това отстъплени понес голем загуб в човешк сили. но по-гол значени на побед в тревненск проход се криел в нейни морал отзву. още веднъж, и този път окончател, тя пока по убедител начин, че българ съществува, че не може да бъде унищож, че нейн съдбин се ръковод от чове, досто да изпъл тежк пове на време. побед през 1190 г. била сигн за всеобщ настъплени на българ в траки и македони.
            действи на ива i асен през следва пет годин мога да бъда характеризира само с едн изречени — усил за постиган на целт постав в 1186 г. — освобождаван и политическ обединени на всичк българск земи. тези усил били осъществява с помощ на уме и гъвкав такти. българск цар разчита на краткотра кампани, на бърз операци, на светкавич поход, коит не винаг носел териториал придобивк, но непрекъсн тревож импери. друга отличител черт на воен планов на ива асен била постоян, и то твърд бърз, всеки път неочаква смяна на посок на нанася удар. така през 1191 г. (или 1192 г.) българ се появ по черноморск крайбрежи и превзе варн и сетн анхиал. и докат иса ii ангел възстановява своет господств над опустош област, ива асен се прехвърл в запад част на полуостров и овладяв средец, ниш и стоб [37]. а наскор след това българск отряд се появ в околност на пловдив [38]. исаак ii се опита да противодейств с различ средств. така например той възлож надежд си на своя братовчед константи ангел, дук на флота, когот назнач за стратег и изпрат в пловдив [39]. но твърд скоро, без да постигн нещо съществ, млади и енергич военачални започн метеж срещу василевса, сетн бил залов и ослеп [40]. веднаг след това ива асен пове войск си на поход и през средец, пловдив, достигн до адрианопол [41], а край аркадиопол нанес поражени на роме, предвожда от алексий гид и васили вата [42], показва очертава се превъзходств на българск държав.
            при това положени на исаак ii ангел не остава нищо друго, освен да интернационализир конфликт (за пръв път от 1186 г.!) и да се опи да се справи с българ, използва външ помощ. за да подготв поле за подоб акци, византийск василевс потегл на поход срещу сърб [43], коит били в съюз с българ от време на трети кръстонос поход. след извест сполу той пристъп към изпълнени на втора част от плана си: потърс сътрудничеств на тъст си унгарск крал бела iii и се уговор с него за съвмест воен действи срещу българ през пролет на 1195 г. [44] планът на исаак ii ангел бил добре замисл, но остан само план. когат василевсът се подготв за самат кампа, заговор организира от брат му алексий сполуч и той бил свален от власт, лишен от зрени и хвърл в затвор [45]. нови император има достатъч грижи окол утвърждаван си на престол и не само се отка от замисл воен кампа срещу българ, но и се опита да сключи мир с ива асен. ники хониат специал подчертав негов усил, пишейк недвусмисл, че алексий iii ангел първ стори крачк към мира, койт не бил постигн, тъй като услови на ива i асен били „безчест за роме“ [46]. византийск истори премълчав какв са били искан на българ и това мълчани дава възможност за различ тълкува [47]. няма съмнени, че тъкмо по това време българск цар не е има сериоз намер да сключв мир с византи. на българ в 1195 г. не бил нужен сигур и продължител мир, койт би й затвор пътя към постиган на основ цел — освобождени и обединени на всичк българск земи. ива асен не само че не жела да се отка от планов си или поне да ги отсроч, но съзира, че момент е твърд удоб за тяхно осъществяван: нови василевс трябва да се погри за собств си положени. но по-важ било друго — за първ път от нача на освободител войн импери прояв слабост и потърс мира с българ. при това положени ива асен реши, че трябва да постав такив услов, коит биха принуд византи сами да се отка от жела от тях мир. това неприемлив „безчест“ искан, коет възмут ники хониат (а и василевса, разбир се!), би могл да бъде само едн: искан отправ към фридр i барбарос българск владет да получ корон на византийск василевси. но този път това искан било отправ не към чужден, а към сами константинопол и ива асен не остан изненада от отговор, защот го очаква. нещо повеч, отрицател отговор му бил необход (заед с мотиваци, че алексий iii ангел е незакон василевс, тира), за да оправда, ако стане нужд, по-нататъш си воен действи срещу византи [48].
            едв византийск пратени били напусн търнов и ива асен, без да губи време, пристъп към изпълнени на намерен си. този път той остав траки на спокойстви и насоч своя поглед към северозапад част на полуостров и македони. категорич сведен в извор липсва, но анализ на по-къс извест показв, че към това време били освобо и присъедин към българск държав област окол браничев и белград [49]. отта ива асен се спусн на юг и налож трайн своят власт над средец (софи). тъкмо тогав той наред да пренес в търнов мощи на св. ива рилск (маджар наскор ги били върн след краткотра пребиваван в естергом) [50]. след това, придвижва се по долин на струма, той достигн до източ македони, къде в едн сражени край сяр разби изпрат насрещ му византийск войск и плени нейни стратег алексий аспие [51]. през следва 1196 г. ива асен продълж настъплени си в съща посок. хониат съобщав, че с „още по-гол самоувереност той нападн област окол стримон и амфипол“. и пак край сяр се срещн с нова византийск войск, този път командва от императорск зет севастократор исаак. сражени завърш с пълн побед на българ, а сами исаак, койт не разб „воен хитрост и измам“ на ива асен, „бил пленен“ [52].
            победонос действи на ива асен, за когот няма препятстви на бойно поле, били спрени изненадва, и то по друг начин: българск цар бил уби от иванк [53]. убийств на българск цар е било обект на много и различ обясн [54]. но анализ на извор — както на провиденциалистк елемент в разка (предсказани на византийск свещени за очаква насилств смърт на българск цар), така и на прикри чрез тях реалност — показв без колебани, че ива асен става все по-сил и по-страш враг за византи. тъй като той не можел да бъде спрян на бойно поле, трябва да бъде спрян с други средств. едв ли има съмнени, че роме чрез севастократор исаак сполуч да намер подходя чове в лицет на иванк, да го убед, че е досто да поем царск корон и да го увер в пълн съдействи на византи. остан било лесн [55].
            в края на първ си десетилети възрод българ вече била укрепн и повеч не била застраш от срив. ако в нача (1186 г.) ива i асен и петър били отцепни, узрпатор, а в 1189 г. според хронист на трети кръстонос поход те владеел „по-гол част от българ и откъм дунав, чак дота, къде той се влива в море“ и претендира за „императорск корон на гръцк кралств“, то към 1192–1193 г. тя вече била царств (ники хониат), коет обхваща и част от траки и македони, както и голем облас на север от дунав. българ си има цар и архиепископ, без необходимост от външ „признани“ (византи се противопостав на българ като държав, а не на титл на нейни владет или на сана на нейни църков глава, тъй като според политическ теор това било вътреш проблем на импери), резулта от спонтан движени на българ, коет се основава на историческ традици и приемственост с първ българск царств.
            опит на иванк да узурпир престол, очевид подкрепя от византи, постав съдб на наскор възстанов българск царств на сериоз изпитани. заговорни овла търнов и очаква помощ от алексий iii ангел, за да покор цяла мизи [56]. сега всичк било в ръцет на петър, койт от извест време се бил откъсн от ръководств на държав дела и се установ в апанаж си с цент някогаш българск столиц велик преслав, запазва външ белез на царск власт [57]. от оскъд свидетелств на ники хониат може да се допусн, че петър реагира бърз, обсад престол град, къде се бил укреп иванк [58], но не се осм да го атакува. трудн е да се отсъд кое от двете решен било най-правил, но действи на петър дали резулта. не бива да се забрав, разбир се, че успех на петър се дълж и на византийск нежелани или неумени на импери да се намес по-актив и по-сполучлив в българск дела [59]. факт е обач, че иванк и най-близ му сподвижни намер убежищ в константинопол [60]. по този начин „власт над мизи отнов мина изцял в ръцет на петър“ [61].
            самостоятел царуван на петър било твърд кратк и за него се знае съвсем малк. отнов вижда в действи двувласти. не би могл да се каже със сигурност дали петър се е страхува, че няма да се справи сам или се е опр на съществува вече традици, но хониат пише недвусмисл: той взел за „помощни в  [държав] дела и участни в управлени калоян“ [62]. единств скутариот твърд, че петър, след като взел за свой помощни по-мал си брат, с всичк сили „опустошава ромейск земи“ [63]. а хониат добав, че „нико от нас не се противопостав на петър“ [64]. но нови българск цар няма време да пока държавническ си способност; „малк по-къс“ и той завърш живот си като ива асен — бил прони от меча на свой сънародни [65]. 
            '''

        self.compare_texts(stemmer, stemmed_text, text)

    def test_stem(self):
        stemmer = BulStemmer.from_file(BulStemmerTest.RULES_2_PATH, min_freq=2, left_context=2)
        self.assertEqual('вероят', stemmer.stem('вероятен'))
        self.assertEqual('този', stemmer.stem('този'))

    def test_no_stem_context(self):
        stemmer = BulStemmer.from_file(BulStemmerTest.RULES_2_PATH, left_context=10)
        self.assertEqual('оставката', stemmer.stem('оставката'))

    def test_stem_context1(self):
        stemmer = BulStemmer.from_file(BulStemmerTest.RULES_1_PATH, min_freq=2, left_context=1)
        self.assertEqual('остав', stemmer.stem('оставката'))
        self.assertEqual('той', stemmer.stem('той'))

    def test_stem_context2(self):
        stemmer = BulStemmer.from_file(BulStemmerTest.RULES_2_PATH, min_freq=2, left_context=2)
        self.assertEqual('оставк', stemmer.stem('оставката'))
        self.assertEqual('той', stemmer.stem('той'))

    def test_stem_context3(self):
        stemmer = BulStemmer.from_file(BulStemmerTest.RULES_3_PATH, min_freq=2, left_context=3)
        self.assertEqual('оставк', stemmer.stem('оставката'))
        self.assertEqual('той', stemmer.stem('той'))

    def test_filter_freq(self):
        stemmer = BulStemmer.from_file(BulStemmerTest.RULES_3_PATH, min_freq=200000000)
        self.assertEqual('оставката', stemmer.stem('оставката'))
        self.assertEqual('вероятен', stemmer.stem('вероятен'))

    def test_manual_rules(self):
        stemmer = BulStemmer(["ой ==> о 10"], min_freq=0, left_context=0)
        self.assertEqual('поро', stemmer.stem('порой'))

    def test_allow_duplicates(self):
        stemmer = BulStemmer(["ой ==> о 10", "ой ==> о 30"], min_freq=0, left_context=0, allow_duplicates=True)
        self.assertEqual('поро', stemmer.stem('порой'))

    def test_duplicates_exception(self):
        with self.assertRaises(ValueError):
            BulStemmer(["ой ==> о 10", "ой ==> о 30"], min_freq=0, left_context=0)


if __name__ == '__main__':
    unittest.main()
